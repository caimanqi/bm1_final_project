---
title: "Biostatistics Methods 1 Final Project"
author: "Manqi Cai, Yixi Xu, Peng-Lin Lin, Kaitlin Maciejewski"
date: "12/9/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

The Data Analytics group from Good Health Corporation are interested in improving the overall hospital management and minimizing the cost/resources associated with patients' care. One of the most important outcomes that has a direct effect on these aspects is patient's length of stay (LoS) in the hospital. Thus, they would like to know which variables are associated with LoS, and ultimately build a predictive model to be used for future visits. The group has contacted you to study this problem and make a recommendation.

```{r, warning=F, message=F, include=F}
library(tidyverse)
library(readxl)
library(dplyr)
library(DT)
library(janitor)
library(stringr)
library(lubridate)
library(knitr)
library(GGally) # correlation matrix
library(ggplot2)
```


```{r load_data_set}
ghproject <- read_excel("GHProject_Dataset.xlsx") %>% 
  clean_names()

#summary of continuous variable
ghproject %>% 
  select(losdays2, evisit, ageyear, bmi:bpdiastolic) %>% 
  summary() %>% 
  na.omit() %>% 
  knitr::kable()

#summary of categorical data
##### NEEDS TO BE DONE #####
ghproject %>% 
  select()

#summary of PatientID and VisitID
ghproject %>% 
  distinct(patientid) %>% 
  count()

ghproject %>% 
  distinct(visitid) %>% 
  count()

```
There are 3682 records from 3612 patients

```{r clean_data}
GHProject_Dataset <- read_excel("GHProject_Dataset.xlsx") %>% clean_names() #load data

#remove duplicated patients
ghproject_remove <- GHProject_Dataset[!duplicated(GHProject_Dataset[c('patientid')]),]


#
##recode variables
ghproject_tidy <- ghproject_remove %>% 
  mutate(gender = ifelse(gender == "Male", "1","0" )) %>% #recode gender
  mutate(maritalstatus = ifelse(maritalstatus == "Married","1","0"), #recode marital status
         cindex = recode(cindex, #recode cindex
                         "0" = "0",
                         "1" = "0",
                         "2" = "1",
                         "3" = "1",
                         "4" = "2",
                         "5" = "2"),
         insurancetype = recode(insurancetype, #recode insurance type
                                "NA" = "0",
                                "Private" = "1",
                                "Medicare" = "2",
                                "Medicaid" = "3"),
         mews = recode(mews, #recode mews
                       "NA" = "0",
                       "0" = "1",
                       "1" = "1",
                       "2" = "2",
                       "3" = "2",
                       "4" = "3",
                       "5" = "3",
                       "6"= "4",
                       "7"= "4",
                       "8"= "4",
                       "9"= "4",
                       "10"= "4",
                       "11"= "4",
                       "12"= "4",
                       "13"= "4",
                       "14" = "4"),
         religion = ifelse(religion == "No Affiliation", "0", "1"), #recode religion
         losdays2_log = log(losdays2),
         id = 1:nrow(ghproject_remove)) %>% 
  separate(admitdtm, into= c("day", "month", "year"), sep = ", ", convert = TRUE) %>% #recode admission date to month
  mutate(month = str_replace(month, "[0-9]", ""))%>% 
  mutate(month = str_replace(month, "[0-9]", ""))%>%
  mutate(month = str_replace(month, " ", ""))%>%
  mutate(month = recode(month,
                        "January" = "1",
                        "February" = "2",
                        "March" = "3",
                        "April" = "4",
                        "May" = "5",
                        "June" = "6",
                        "July" = "7",
                        "August" = "8",
                        "September" = "9",
                        "October" = "10",
                        "November" = "11",
                        "December" = "12")) %>% 
  select(-c(day, year, patientid, visitid, postalcode, facilityname, facilityzip, race)) %>% #remove unneeded variables
    na.omit() 

ghproject_tidy$mews <- as.integer(as.character(ghproject_tidy$mews))

ghproject_tidy$cindex <- as.integer(as.character(ghproject_tidy$cindex))

ghproject_tidy$month <- as.integer(as.character(ghproject_tidy$month))

ghproject_tidy$gender <- as.integer(as.character(ghproject_tidy$gender))

ghproject_tidy$religion <- as.integer(as.character(ghproject_tidy$religion))

ghproject_tidy$maritalstatus <- as.integer(as.character(ghproject_tidy$maritalstatus))

ghproject_tidy$insurancetype <- as.integer(as.character(ghproject_tidy$insurancetype))

```


```{r correlation_matrix}
# correlation matrix for numeric variables, saturated
ggpairs(ghproject_tidy, columns = c("month", "ageyear", "bmi", "bpsystolic","o2sat","temperature", "heartrate","respirationrate", "bpdiastolic","losdays2_log"))

# no significant linear trend ??

# correlation matrix, from smaller SAS model
ggpairs(ghproject_tidy, columns = c("ageyear", "bpsystolic", "heartrate","respirationrate", "losdays2_log"))
```

```{r}
ghproject_tidy %>% 
  mutate(heartrate_log = log(heartrate)) %>% 
  ggplot(aes(x = heartrate_log)) +
  geom_histogram()

ghproject_tidy %>% 
  ggplot(aes(x = heartrate)) +
  geom_histogram()
```


```{r write_csv_for_SAS, eval=FALSE}
write_csv(ghproject_tidy, "ghproject_saturated.csv")
```


#SAS output:

##Forward

###significant variables:
ageyear, evisit, bpsystolic, cindex, heartrate, is30dayreadmit, respirationrate

AdjR2: 0.1169

AIC: 1743.8


##Backward

###significant variables:
month, mews, icu_flag, temperature, bmi, o2sat, religion, gender, bpdiastolic, maritalstatus, insurancetype

AdjR2: 0.1169

AIC: 1743.8


##Stepwise

###significant variables:
ageyear, evisit, bpsystolic, cindex, heartrate, is30dayreadmit, respirationrate

AdjR2: 0.1169

AIC: 1743.8

since Forward and Stepwise agree, and using principle of parsimony, choose smaller model

```{r}
#Use criterion-based procedures to guide your selection of the ‘best subset’ (Cp, AIC, BIC, ...)
```


```{r linear_model for stepwise}
reg <- lm(losdays2_log ~ + is30dayreadmit + ageyear + month + cindex + evisit + ageyear + gender + religion + maritalstatus + insurancetype + bpsystolic + o2sat + heartrate +  respirationrate + bpdiastolic, ghproject_tidy)

summary(reg)

confint(reg)

par(mfrow=c(2,2))
plot(reg)
```

```{r}
library(boot)     
# For cv.glm()

##bootstrap
set.seed(1)

# Our usual regression, no bootstrap yet
boot.fn<-function(data, index){
	return(coef(lm(losdays2_log ~ + is30dayreadmit + ageyear + month + cindex + evisit + ageyear + gender + religion + maritalstatus + insurancetype + bpsystolic + o2sat + heartrate +  respirationrate + bpdiastolic,data=ghproject_tidy,subset=index)))
}
boot.fn(ghproject_tidy,1:2709)

# Compute the estimates by sampling with replacement
# Sample chooses 392 observations from 392, with replacement
# Might have duplicates
set.seed(1)

# One draw
boot.fn(ghproject_tidy,sample(2709,2709,replace=T))

# Use function boot() to repeat the sampling 10000 times.
# Repeat 10000 times to get the estimates, SEs ad bias

boot(ghproject_tidy, boot.fn, 1000)

# How does it compare to the original (non-bootstrap) estimates?
summary(reg)
```

